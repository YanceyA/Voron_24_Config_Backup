#####################################################################
#   Temperature Wait Configuration
#####################################################################
[gcode_macro _TEMP_WAIT_CFG]
# Default allowed range around target (in °C) for waits
# Adjust here to tune behavior globally without touching slicer G-code
variable_extruder_deadband: 6.0   # ±3°C around target by default
variable_bed_deadband: 6.0        # ±3°C around target by default
variable_chamber_deadband: 10.0   # ±5°C around target by default
gcode:

#####################################################################
#   M109 - Wait Hotend Temp (with deadband)
#####################################################################
[gcode_macro M109]
rename_existing: M109.1
gcode:
    # Parameters
    {% set s = params.S|float %}
    {% set cfg = printer["gcode_macro _TEMP_WAIT_CFG"] %}
    {% set deadband = (params.D|float) if (params.D is defined) else (cfg.extruder_deadband|float) %}

    # Always set temperature; wait only if non-zero target
    {% if params.T is defined and params.S is defined %}
        M104 T{params.T} S{s}
    {% elif params.S is defined %}
        M104 S{s}
    {% else %}
        M104
    {% endif %}
    {% if s != 0 %}
        # Center the allowed range around the target
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s - (deadband/2.0)} MAXIMUM={s + (deadband/2.0)}
    {% endif %}


#####################################################################
#   M190 - Wait Bed Temp (with deadband)
#####################################################################
[gcode_macro M190]
rename_existing: M190.1
gcode:
    # Parameters
    {% set s = params.S|float %}
    {% set cfg = printer["gcode_macro _TEMP_WAIT_CFG"] %}
    {% set deadband = (params.D|float) if (params.D is defined) else (cfg.bed_deadband|float) %}

    {% if params.S is defined %}
        M140 S{s}
    {% else %}
        M140
    {% endif %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s - (deadband/2.0)} MAXIMUM={s + (deadband/2.0)}
    {% endif %}

#####################################################################
#   M191 - Wait Chamber Temp (with deadband)
#####################################################################
[gcode_macro M191]
gcode:
    # Parameters
    {% set s = params.S|float %}
    {% set cfg = printer["gcode_macro _TEMP_WAIT_CFG"] %}
    {% set deadband = (params.D|float) if (params.D is defined) else (cfg.chamber_deadband|float) %}

    SET_HEATER_TEMPERATURE HEATER=chamber_heater TARGET={s}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR='heater_generic chamber_heater' MINIMUM={s - (deadband/2.0)} MAXIMUM={s + (deadband/2.0)}
    {% endif %}
    

[gcode_macro M141] # Set Chamber Temp
gcode:
    #Parameters
    {% set s = params.S|float %}

    SET_HEATER_TEMPERATURE HEATER=chamber_heater TARGET={ s }   # Set bed temp
